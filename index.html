<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Oro - V6 (Corregida)</title>
    <style>
        /* ESTILOS (DISE√ëO) */
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: #f1f2f6; margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 450px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* Encabezado */
        .header { background: #2f3542; color: #ffa502; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-ai { background: transparent; border: 1px solid #ffa502; color: #ffa502; padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-ai:hover { background: #ffa502; color: #2f3542; }

        .content { padding: 15px; }

        /* PANEL ASISTENTE (Oculto) */
        #aiPanel { display: none; background: #2f3542; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ffa502; }
        .ai-grid { display: flex; gap: 10px; margin-bottom: 10px; }
        .ai-input { flex: 1; }
        .ai-input label { font-size: 10px; color: #ccc; display: block; margin-bottom: 2px; }
        .ai-input input { width: 100%; background: #57606f; border: none; color: white; padding: 8px; text-align: center; border-radius: 4px; box-sizing: border-box; }
        
        /* Tabla Gu√≠a */
        .guide-table { width: 100%; font-size: 13px; border-collapse: collapse; margin-top: 5px; }
        .guide-table td { border-bottom: 1px solid #57606f; padding: 6px; }
        .safe-val { color: #2ed573; font-weight: bold; text-align: right; }

        /* Inputs Principales */
        label { font-weight: bold; color: #2f3542; display: block; margin-top: 15px; font-size: 14px; margin-bottom: 5px; }
        input.main-input, select.main-input { width: 100%; padding: 12px; border: 1px solid #ced6e0; border-radius: 8px; font-size: 18px; text-align: center; box-sizing: border-box; background: #fff; }
        input.main-input:focus { border-color: #ffa502; outline: none; border-width: 2px; }

        /* INTERRUPTOR (Gramo vs Castellano) */
        .switch-box { display: flex; background: #dfe4ea; border-radius: 8px; padding: 4px; margin-top: 5px; }
        .switch-box input { display: none; } /* Ocultar radio buttons reales */
        .switch-box label { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-radius: 6px; font-size: 14px; color: #747d8c; font-weight: bold; transition: 0.2s; }
        
        /* Estilo cuando est√° seleccionado */
        input:checked + label { background-color: #3742fa; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* EL CHISMOSO (Referencias) */
        .ref-box { background-color: #f1f2f6; border: 1px solid #a4b0be; border-radius: 8px; padding: 10px; margin-top: 15px; display: none; } 
        .ref-flex { display: flex; justify-content: space-between; text-align: center; }
        .ref-item span { display: block; font-size: 11px; color: #57606f; }
        .ref-item strong { display: block; font-size: 14px; color: #3742fa; }

        /* Resultados */
        .results { background: #fff7d2; border: 2px solid #ffa502; border-radius: 10px; padding: 15px; margin-top: 20px; text-align: center; }
        .res-top { display: flex; justify-content: space-around; font-size: 14px; color: #57606f; border-bottom: 1px solid #ffeaa7; padding-bottom: 8px; margin-bottom: 5px; }
        .total-big { font-size: 32px; font-weight: 800; color: #2f3542; margin-top: 5px; display: block; }
        .alert-msg { font-size: 13px; font-weight: bold; margin-top: 8px; min-height: 20px; display: block; }

        /* Botones Acci√≥n */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button.action { flex: 1; padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 16px; }
        .btn-clr { background: #ff4757; width: 30%; }
        .btn-save { background: #2ed573; width: 70%; }

        /* Historial */
        .history { margin-top: 25px; border-top: 1px dashed #ced6e0; padding-top: 15px; }
        .history h4 { font-size: 12px; text-align: center; color: #a4b0be; margin: 0 0 10px 0; text-transform: uppercase; }
        #lista { padding: 0; margin: 0; list-style: none; }
        #lista li { background: white; padding: 10px; margin-bottom: 8px; border-left: 4px solid #3742fa; font-size: 13px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>üíé CALCULADORA TANGOLD</h2>
        <button class="btn-ai" onclick="togglePanel()">ü§ñ Asistente</button>
    </div>

    <div class="content">
        <div id="aiPanel">
            <div style="text-align:center; font-size:12px; color:#ffa502; margin-bottom:10px;">CONFIGURAR MERCADO HOY</div>
            <div class="ai-grid">
                <div class="ai-input">
                    <label>ONZA (USD)</label>
                    <input type="number" id="spot" placeholder="Ej: 2650" oninput="calcularGuia()">
                </div>
                <div class="ai-input">
                    <label>D√ìLAR (COP)</label>
                    <input type="number" id="trm" placeholder="Ej: 4100" oninput="calcularGuia()">
                </div>
            </div>
            <table class="guide-table">
                <tbody id="tablaGuia">
                    <tr><td colspan="2" style="text-align:center; color:#ccc;">Ingresa datos arriba...</td></tr>
                </tbody>
            </table>
        </div>

        <label>‚öñÔ∏è PESO (Oro fundido):</label>
        <input type="number" id="gramos" class="main-input" placeholder="0.00" step="0.01" oninput="calcularMaestro()">

        <label>üè∑Ô∏è LEY (Calidad):</label>
        <select id="ley" class="main-input" onchange="calcularMaestro()">
            <option value="Fundido">Oro Fundido (General)</option>
            <option value="Ley 900">Ley 900 (Alta)</option>
            <option value="Ley 875">Ley 875</option>
            <option value="Ley 750">Ley 750 (18k)</option>
            <option value="Chatarra">Chatarra</option>
        </select>

        <label>ü§ù PRECIO NEGOCIADO:</label>
        <div class="switch-box">
            <input type="radio" id="modoGramo" name="modo" value="gramo" checked onchange="calcularMaestro()">
            <label for="modoGramo">Por GRAMO</label>

            <input type="radio" id="modoCast" name="modo" value="castellano" onchange="calcularMaestro()">
            <label for="modoCast">Por CASTELLANO</label>
        </div>
        
        <input type="number" id="precio" class="main-input" placeholder="$ 0" style="margin-top:10px; color:#3742fa; font-weight:bold;" oninput="calcularMaestro()">

        <div class="ref-box" id="cajaRef">
            <div style="font-size:10px; text-align:center; color:#747d8c; margin-bottom:5px;">EQUIVALENCIAS:</div>
            <div class="ref-flex">
                <div class="ref-item"><span>Real:</span><strong id="refReal">$0</strong></div>
                <div class="ref-item"><span>Gramo:</span><strong id="refGramo">$0</strong></div>
                <div class="ref-item"><span>Cast:</span><strong id="refCast">$0</strong></div>
            </div>
        </div>

        <div class="results">
            <div class="res-top">
                <span>üì¶ Cast: <b id="resCast">0.00</b></span>
                <span>üíé Reales: <b id="resReales">0.00</b></span>
            </div>
            <span style="font-size:11px; color:#747d8c;">TOTAL A PAGAR:</span>
            <span class="total-big" id="resTotal">$0</span>
            
            <div id="alertaIA" class="alert-msg"></div>
        </div>

        <div class="btn-group">
            <button class="action btn-clr" onclick="limpiar()">Borrar</button>
            <button class="action btn-save" onclick="guardar()">Guardar</button>
        </div>

        <div class="history">
            <h4>üìù Historial Reciente</h4>
            <ul id="lista"></ul>
        </div>
    </div>
</div>

<script>
    // --- VARIABLES GLOBALES ---
    let preciosSeguros = {}; // Aqu√≠ guardamos lo que dice la IA

    // --- 1. FUNCI√ìN DEL ASISTENTE (IA) ---
    function togglePanel() {
        let panel = document.getElementById('aiPanel');
        if(panel.style.display === 'block') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'block';
        }
    }

    function calcularGuia() {
        let spot = parseFloat(document.getElementById('spot').value) || 0;
        let trm = parseFloat(document.getElementById('trm').value) || 0;
        let tabla = document.getElementById('tablaGuia');

        if(spot > 0 && trm > 0) {
            // Matem√°tica: (Onza * Dolar) / 31.1035 gramos por onza
            let precioGramoPuro = (spot * trm) / 31.1035;
            
            // Margen de seguridad del 15% (El negocio paga al 85% del internacional)
            let margen = 0.85;

            // Guardamos los precios m√°ximos sugeridos
            preciosSeguros = {
                'Ley 900': precioGramoPuro * 0.90 * margen,
                'Ley 750': precioGramoPuro * 0.75 * margen,
                'Chatarra': precioGramoPuro * 0.58 * margen
            };

            // Dibujamos la tabla verde
            let html = '';
            // Usamos concatenaci√≥n simple para evitar errores de copia
            html += '<tr><td>Ley 900</td><td class="safe-val">' + moneda(preciosSeguros['Ley 900']) + '</td></tr>';
            html += '<tr><td>Ley 750</td><td class="safe-val">' + moneda(preciosSeguros['Ley 750']) + '</td></tr>';
            html += '<tr><td>Chatarra</td><td class="safe-val">' + moneda(preciosSeguros['Chatarra']) + '</td></tr>';
            
            tabla.innerHTML = html;
            
            // Recalculamos por si acaso ya hab√≠a un precio puesto
            calcularMaestro();
        }
    }

    // --- 2. EL CEREBRO PRINCIPAL (CALCULAR TODO) ---
    function calcularMaestro() {
        // A. Obtener valores
        let gramos = parseFloat(document.getElementById('gramos').value) || 0;
        let precioUsuario = parseFloat(document.getElementById('precio').value) || 0;
        
        // B. Detectar modo (Gramo o Castellano)
        let radioGramo = document.getElementById('modoGramo');
        let modo = radioGramo.checked ? 'gramo' : 'castellano';

        // C. Conversiones de Peso
        let castellanos = gramos / 4.6;
        let reales = castellanos * 16;

        // D. C√°lculos de Dinero
        let total = 0;
        let pGramo = 0, pCast = 0, pReal = 0;

        if (precioUsuario > 0) {
            document.getElementById('cajaRef').style.display = 'block';

            if (modo === 'gramo') {
                // Si negocia por gramo
                total = gramos * precioUsuario;
                pGramo = precioUsuario;
                pCast = precioUsuario * 4.6;
                pReal = precioUsuario * 0.2875;
            } else {
                // Si negocia por castellano
                total = castellanos * precioUsuario;
                pCast = precioUsuario;
                pGramo = precioUsuario / 4.6;
                pReal = precioUsuario / 16;
            }
        } else {
            document.getElementById('cajaRef').style.display = 'none';
        }

        // E. Mostrar en Pantalla (Resultados num√©ricos)
        document.getElementById('resCast').innerText = castellanos.toFixed(4);
        document.getElementById('resReales').innerText = reales.toFixed(2);
        document.getElementById('resTotal').innerText = moneda(total);

        // F. Mostrar Referencias (El Chismoso)
        document.getElementById('refGramo').innerText = moneda(pGramo);
        document.getElementById('refCast').innerText = moneda(pCast);
        document.getElementById('refReal').innerText = moneda(pReal);

        // G. VERIFICACI√ìN DE IA (Sem√°foro)
        verificarSeguridad(pGramo);
    }

    // --- 3. VERIFICADOR DE SEGURIDAD ---
    function verificarSeguridad(precioGramoActual) {
        let alertaDiv = document.getElementById('alertaIA');
        let leySeleccionada = document.getElementById('ley').value;
        let precioTope = preciosSeguros[leySeleccionada];

        // Solo verificamos si la IA fue configurada y hay un precio puesto
        if (precioTope && precioGramoActual > 0) {
            if (precioGramoActual > precioTope) {
                // PELIGRO
                alertaDiv.innerHTML = '<span style="color:#ff4757">‚ö†Ô∏è RIESGO: Pagando por encima del sugerido (' + moneda(precioTope) + ')</span>';
            } else {
                // SEGURO
                alertaDiv.innerHTML = '<span style="color:#2ed573">‚úÖ PRECIO SEGURO (Margen OK)</span>';
            }
        } else {
            alertaDiv.innerHTML = '';
        }
    }

    // --- UTILIDADES ---
    function moneda(valor) {
        if (!valor) return '$0';
        return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(valor);
    }

    function limpiar() {
        document.getElementById('gramos').value = '';
        document.getElementById('precio').value = '';
        document.getElementById('cajaRef').style.display = 'none';
        document.getElementById('alertaIA').innerHTML = '';
        
        // Resetear visuales a cero
        document.getElementById('resTotal').innerText = '$0';
        document.getElementById('resCast').innerText = '0.00';
        document.getElementById('resReales').innerText = '0.00';
        
        document.getElementById('gramos').focus();
    }

    function guardar() {
        let total = document.getElementById('resTotal').innerText;
        if(total === '$0') return;

        let gramos = document.getElementById('gramos').value;
        let ley = document.getElementById('ley').value;
        let lista = document.getElementById('lista');
        let item = document.createElement('li');
        
        let fecha = new Date();
        let hora = fecha.getHours() + ':' + (fecha.getMinutes()<10?'0':'') + fecha.getMinutes();

        item.innerHTML = '<span><b>' + hora + '</b>: ' + gramos + 'g (' + ley + ')</span> <b>' + total + '</b>';
        
        lista.insertBefore(item, lista.firstChild);
        if(lista.children.length > 10) lista.removeChild(lista.lastChild);
    }
</script>

</body>
</html>